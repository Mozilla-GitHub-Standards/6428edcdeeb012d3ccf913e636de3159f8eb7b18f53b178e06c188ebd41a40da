#!/bin/bash

if [ $# -ne 4 ]; then
  echo 'arguments: <repo_url> <ref_repo_url> <sha> <pulls_path>'
  echo
  exit
fi

#
# Set up vars
#
TARGET_URL=$1
REF_URL=$2
SHA=$3
# Get absolute path for current dir
SCRIPT_DIR="$( cd "$( dirname "$0" )" && pwd )"
# Hack to get absolute path for pulls
mkdir -p $4; cd $4
PULLS_DIR="$( cd "$( dirname "$0" )" && pwd )"
TARGET_DIR=$PULLS_DIR/tests/$SHA
cd $SCRIPT_DIR

if [ -d $TARGET_DIR ]; then
  echo 'target dir (' $TARGET_DIR ') already exists - overwriting it...'
  rm -rf $TARGET_DIR
fi

#
# Fetch git repo to be tested (target), checkout desired sha
#
mkdir -p $TARGET_DIR
cd $TARGET_DIR
git init; git fetch $TARGET_URL; git checkout $SHA

#
# Pull up-to-date reference snapshots
#
mkdir -p $TARGET_DIR/test/ref
cd $TARGET_DIR/test/ref
git init; git pull -f $REF_URL

#
# Deploy manifest files, run tests
#
cd $TARGET_DIR
cp -f $SCRIPT_DIR/test-files/test_manifest.json ./test
cp -f $SCRIPT_DIR/test-files/browser_manifest.json ./test/resources/browser_manifests
cp -f $SCRIPT_DIR/test-files/Makefile .
make test

#
# Erase everything but eq.log; keep dir to tell bot we already processed that commit
#
# cd $TARGET_DIR
# find . ! -iname 'eq.log' -delete
