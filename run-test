#!/bin/bash
#
# Clone source repo to be tested and run tests
#


if [ $# -ne 4 ]; then
  echo 'arguments: <repo_url> <sha> <ref_repo_url> <temp_path>'
  echo
  exit
fi

#
# Set up vars
#
TARGET_URL=$1
SHA=$2
REF_URL=$3
# Get absolute path for current dir
SCRIPT_DIR="$( cd "$( dirname "$0" )" && pwd )"
# Hack to get absolute path for tmp path
mkdir -p $4; cd $4
TMP_DIR="$( cd "$( dirname "$0" )" && pwd )"
TARGET_DIR=$TMP_DIR/tests/$SHA
cd $SCRIPT_DIR

if [ -d $TARGET_DIR ]; then
  echo 'target dir (' $TARGET_DIR ') already exists - overwriting it...'
  rm -rf $TARGET_DIR
fi

#
# Fetch git repo to be tested (target), checkout desired sha
#
mkdir -p $TARGET_DIR
cd $TARGET_DIR
git clone $TARGET_URL .; git checkout --quiet $SHA

#
# Pull reference snapshots
#
mkdir -p $TARGET_DIR/test/ref
cd $TARGET_DIR/test/ref
git init; git pull -f $REF_URL
echo
echo "***"
echo "Reference snapshots generated from:"
cat REF-INFO
echo "***"
echo


#
# Check if commit/SHA used to generate snapshots is present in target history
# (can't proceed with test if not, as it means commit/SHA has not been 
#  merged yet)
#
cd $TARGET_DIR/test/ref
ORIGINAL_SHA=`grep 'sha' REF-INFO | sed -e 's/sha \([0-9a-z]*\)/\1/g'` # get SHA from REF-INFO
COMMIT_EXISTS=`cd $TARGET_DIR; git show $ORIGINAL_SHA --format="commit exists: %h" | grep 'commit exists'` # ask git if SHA exists in index
if [ -z "$COMMIT_EXISTS" ]; then # is COMMIT_EXISTS zero-length? (i.e. no match)
  echo
  echo "***"
  echo "WARNING: This pull request does not contain the commit used to generated reference snapshots"
  echo "         But if the tests all pass, that is generally OK."
  echo "***"
fi

#
# Copy existing PDFs *from* local cache
#
cd $TARGET_DIR
cp -n /tmp/pdf-cache/* test/pdfs

#
# Deploy test/ files, run tests
#
cd $TARGET_DIR
cp -f $SCRIPT_DIR/test-files/browser_manifest.json ./test/resources/browser_manifests
cp -f $SCRIPT_DIR/test-files/test_manifest.json ./test 2>/dev/null
cp -f $SCRIPT_DIR/test-files/test.py ./test 2>/dev/null
Xvfb :1 1>/dev/null 2>/dev/null &
make test
killall -9 Xvfb 1>/dev/null 2>/dev/null

#
# Copy new PDFs *to* local cache
#
cd $TARGET_DIR
mkdir -p /tmp/pdf-cache
cp -n test/pdfs/*.pdf /tmp/pdf-cache

#
# Erase everything but eq.log and reftest-analyzer
#
cd $TARGET_DIR
mv -f test/eq.log . 2>/dev/null
mv -f test/resources/reftest-analyzer.xhtml . 2>/dev/null
find . ! -iname 'eq.log' -and ! -iname 'reftest-analyzer.xhtml' -delete
